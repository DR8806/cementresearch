```{r}
library(tidyverse)
library(vars)
library(here)
library(devtools)
library(ggplot2)
library(forecast)
library(tseries)
library(urca)
library(TTR)
```

## Loading the data set 


```{r}
setwd("C:/Users/User/Desktop/R_Data_Science/cementresearch/")
df <- read_csv("data/combinedata2.csv")

df_ts <- ts(df |> dplyr::select(!year), start = 1968, frequency = 1) #convert df tibble into a time series from 1998 to 2020


setwd("C:/Users/User/Desktop/R_Data_Science/cementresearch/")
gdp_annual_percent <- read_csv("data/gdp_annual_percent.csv") #https://fred.stlouisfed.org/series/A191RL1Q225SBEA

## Don't know if using this yet 

```


# After new data set including 1968 - 2021
VARS: cpi, unemploy, gdp, oilprice, population, Cement, housing, gasppi, workers
```{r}

# ------- CPI ---------

adf.test(df$cpi) #not stationary
adf.test(diff(df$cpi)) #1st order difference -> becomes stationary

# ------- unemploy ---------

adf.test(df$unemploy) #not stationary
adf.test(diff(df$unemploy)) 

# ------- GDP ---------

adf.test(df$gdp) # not stationary
adf.test(diff(df$gdp)) #1st order difference -> becomes stationary


# ------- oilprice ---------

adf.test(df$oilprice) # not stationary
adf.test(diff(df$oilprice)) #1st order difference -> becomes stationary

# ------- population ---------

adf.test(df$population) # not stationary
adf.test(diff(df$population,differences = 3)) #3rd order difference -> becomes stationary

plot.ts(ts(diff(df$population,differences = 3), start = 1968, frequency = 1))

# ------- Cement ---------

adf.test(df$Cement)# not stationary
adf.test(diff(df$Cement)) #1st order dif -> becomes stationary

# ------- housing ---------

adf.test(df$housing) # not stationary
adf.test(diff(df$housing)) #1st order dif -> becomes stationary

# ------- gasppi ---------

adf.test(df$gasppi) # not stationary
adf.test(diff(df$gasppi,differences = 2)) #2nd order dif -> becomes stationary

# ------- workers ---------

adf.test(df$workers) # not stationary
adf.test(diff(df$workers)) #2nd order dif -> becomes stationary

# ----------------------

diff_1_vars <- df[,c("cpi","unemploy","oilprice","Cement","housing","workers")]
diff_1_vars <- ts(diff_1_vars, start = 1968, frequency = 1)
diff_1_vars <- lapply(diff_1_vars,function(x) diff(x))


diff_2_vars <- diff(ts(df$gasppi, start = 1968, frequency = 1),differences = 2)
diff_3_vars <- diff(ts(df$population,start = 1968, frequency = 1),differences = 3)

max_start <- max(start(diff_1_vars), start(diff_2_vars), start(diff_3_vars))
differenced_df <- cbind(
  as.data.frame(lapply(diff_1_vars, function(x) window(x, start = max_start))), 
  as.data.frame(window(diff_2_vars,start = max_start)),
  as.data.frame(window(diff_3_vars,start = max_start))
)

# renaming the last two columns gasppi (2nd to last) and population (last)
current_colnames <- colnames(differenced_df)
current_colnames[(length(current_colnames) - 1):length(current_colnames)] <- c("gasppi", "population")
colnames(differenced_df) <- current_colnames

# turning it back into a time series format (this is in rates)
differenced_df <- ts(differenced_df, start = max_start, frequency = 1)


## --- Affirming that all variables are now stationary ---- POSITIVE

adf_results <- lapply(differenced_df, function(variable) {
  adf_result <- adf.test(variable)
  return(adf_result)
})

for (i in seq_along(adf_results)) {
  variable_name <- names(differenced_df)[i]
  p_value <- adf_results[[i]]$p.value
  stationary_status <- ifelse(p_value < 0.05, "Stationary", "Non-Stationary")
  
  cat("Variable:", variable_name, "\n")
  cat("P-Value:", p_value, "\n")
  cat("Status:", stationary_status, "\n\n")
}

```

## VAR STUFF

```{r}

dummy_var <- data.frame(year = max_start:2021) |>
  mutate(value = case_when(year %in% c(2008,2009) ~ 1,TRUE ~ 0))

dummy_var <- ts(dummy_var[,-1],start = max_start, frequency = 1)
merged_data <- cbind(differenced_df,dummy_var)

optimal_lag <- VARselect(merged_data,lag.max = 10) #gives AIC of 5, which is interesting...
optimal_lag <- optimal_lag$selection[1]
var_model <- VAR(merged_data, p = 1)

forecast <- predict(var_model, n.ahead = 10)
par(mar = c(1, 1, 1, 1))
plot(forecast)

forecast_original <- cumsum(forecast$fcst$differenced_df.Cement) + df$Cement[1] #the original value in 1968
```

## Plotting Historic and Forecast on a plot.ts

```{r}
full_years <- seq(1968, 2030, by = 1)

full_ts <- zoo(NA, full_years)

full_ts[time(ts(df$Cement, start = 1968, frequency = 1))] <- coredata(ts(df$Cement, start = 1968, frequency = 1))

full_ts[time(ts(forecast$fcst$differenced_df.Cement[,1], start = 2021, frequency = 1))] <- coredata(ts(forecast$fcst$differenced_df.Cement[,1], start = 2021, frequency = 1))

full_ts_ts <- as.ts(full_ts)

plot.ts(full_ts_ts)
```

